provider "vsphere" {
  user           = var.vsphere_user
  password       = var.vsphere_password
  vsphere_server = var.vsphere_server   

  allow_unverified_ssl = true
}

data "vsphere_datacenter" "dc" {
  name = "Datacenter"
}

data "vsphere_virtual_machine" "template" {
    name = "dhkim-template-test"
    datacenter_id = data.vsphere_datacenter.dc.id
}

data "vsphere_datastore" "datastore" {
  name          = "vsanDatastore"
  datacenter_id = data.vsphere_datacenter.dc.id
}

data "vsphere_resource_pool" "pool" {
  name          = "Cluster/Resources"
  datacenter_id = data.vsphere_datacenter.dc.id
}

data "vsphere_network" "network" {
  name          = "Management Port Group"
  datacenter_id = data.vsphere_datacenter.dc.id
}

resource "vsphere_virtual_machine" "vm" {
    count = "1"
    name = "dhkim-template-Test-0000-${count.index +1}"
    resource_pool_id = data.vsphere_resource_pool.pool.id
    datastore_id = data.vsphere_datastore.datastore.id

    num_cpus = 1
    memory = 4096
    guest_id = "centos7_64Guest"

    network_interface {
        network_id = data.vsphere_network.network.id
    }

    disk {
        label = "disk0"
        size  = "20"
    }  

    clone {
        template_uuid = data.vsphere_virtual_machine.template.id
        customize {
            timeout = 0

            linux_options {
                host_name = "tp-deploy-test"
                domain = "rpcb.local"
            }
            
            # for DHCP
            network_interface {
              ipv4_address = "${var.vm_ip}"
              ipv4_netmask = "${var.vm_netmask}"
            }
            ipv4_gateway = "${var.vm_gateway}"

            dns_server_list = "${split(",", var.vm_dns_servers)}"
            dns_suffix_list = ["${var.vm_domain}"]
        }
    }
}